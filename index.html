<!DOCTYPE html>
<html lang="en-ES">
<head>
    <meta charset="UTF-8">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" rel="stylesheet"/>
	
	<script src="acorn_interpreter.js"></script>
	<script src="acorn.js"></script>
	<script src="interpreter.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed"></script>
    <script src="https://unpkg.com/blockly/python_compressed"></script>
    <script src="https://unpkg.com/blockly/msg/es.js"></script>
    <script src="blocks.js"></script>

<body>

  <div class="content">
    <div class="demo">
		<button onclick="updateCode();">Ejecutar</button>
		<div id="blocklyDiv" style="height: 600px; width: 900px;"></div>        
    </div>

	<p>
		<button onclick="updateCodeSteps()" id="stepButton">Step JavaScript</button>
	</p>
  
    <div class="space-game">
      	<div id="cuadrado"></div>
      	<img id="flag" class="img-flag" src="https://cdn-icons-png.flaticon.com/512/33/33871.png"/>
	</div>
  </div>
  
  </div>
</body>

<script>


    var flag = document.getElementById('flag');
    var bandera = flag.getBoundingClientRect();
    
    console.log('flag-top:', bandera);
    
function ballPosition() {
    const element = document.getElementById('cuadrado');
    const ball = element.getBoundingClientRect();

    if( ball.top == 341 && ball.left == 1394 ){
        alert("Adentro, lo lograste!").destroy();
    }
    console.log('cuadrado-top:', ball.top, 'cuadrado-left:', ball.left);

}

const toolbox = {
    "contents": [
    {
    "kind": "CATEGORY",
    "name": "Loops",
    "colour": "%{BKY_LOOPS_HUE}",
    "contents": [
    {
        "kind": "BLOCK",
        "type": "controls_repeat_ext",
        "inputs": {
        "TIMES": {
            "shadow": {
            "type": "math_number",
            "fields": {"NUM": 10}
            }
        }
        }
    },
    {
        "kind": "BLOCK",
        "type": "controls_whileUntil"
    }
    ]
    },
    {
    "kind": "SEP"
    },
    {
    "kind": "CATEGORY",
    "name": "Variables",
    "custom": "VARIABLE",
    "colour": "%{BKY_VARIABLES_HUE}",
    },
    {
    "kind": "CATEGORY",
    "name": "Functions",
    "custom": "PROCEDURE",
    "colour": "%{BKY_PROCEDURES_HUE}",
    },
    { 
    "kind": "category",
    "name": "Movements",
    "colour": "%{BKY_PROCEDURES_HUE}",
    "contents": [
            {
            "kind": "block",
            "type": "mover",
            },
            {
            "kind": "block",
            "type": "move_up",
            },
            {
            "kind": "block",
            "type": "move_down"
            },
            {
            "kind": "block",
            "type": "move_left"
            },
            {
            "kind": "block",
            "type": "move_rigth"
            },
        ]
    },
]
};
    var workspace = Blockly.inject('blocklyDiv', {toolbox:toolbox});

    function highlightBlock(id) {
        workspace.highlightBlock(id);
    }

	function updateCode() {
		const code = Blockly.JavaScript.workspaceToCode(workspace);
		Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
		Blockly.JavaScript.addReservedWords('code');
		eval(code);
        ballPosition();
	}
    
  var myInterpreter = {};

  function initApi(interpreter, globalObject) {
    // Add an API function for the move() block.
    var wrapper = function(text) {
      return mover(arguments.length ? text : '');
    };
    interpreter.setProperty(globalObject, 'mover',
        interpreter.createNativeFunction(wrapper));

    // Add an API function for the prompt() block.
    wrapper = function(text) {
        return highlightBlock(text);
    };
    interpreter.setProperty(globalObject, 'highlightBlock',
    interpreter.createNativeFunction(wrapper));
  } 
  
  function updateCodeSteps() {
      Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
      Blockly.JavaScript.addReservedWords('code');
    
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      
      myInterpreter = new Interpreter(code, initApi);
      console.log("myInterpreter", myInterpreter);
      
      console.log("generated code:", code);
      //eval(code);
      ballPosition();
      nextStep();
      
    }
    
    var wait_flag = false;
	
	function nextStep() {

    //console.log("myInterpreter2", myInterpreter);
    if (myInterpreter.step()) {
        let timer = 1;        
        if(wait_flag){
        timer = 30;
        ballPosition();

    }else{
        timer = 1;
    }
    wait_flag = !wait_flag;
    setTimeout(nextStep, timer);
}
    
}
	
    // workspace.addChangeListener(updateCode);
</script>
<script src="move.js"></script>

</html>